name: deploy sing-box via cloudflared

on:
  workflow_dispatch:
    inputs:
      filter:
        type: choice
        description: 'Which type of release to deploy?'
        options:
          - prerelease
          - release

jobs:
  poll:
    name: Poll latest sing-box release
    runs-on: ubuntu-latest
    env:
      FILTER: ${{ github.event.inputs.filter || 'prerelease' }}
    outputs:
      tag: ${{ steps.get.outputs.tag }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest ${{ env.FILTER }} info
        id: get
        run: |
          info=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases)
          if [ "$FILTER" = "prerelease" ]; then
            tag=$(echo "$info" | jq -r '[.[] | select(.prerelease==true)][0].tag_name')
          else
            tag=$(echo "$info" | jq -r '[.[] | select(.prerelease==false)][0].tag_name')
          fi
          [ -z "$tag" ] && exit 0
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: Check last deployed tag
        id: check
        run: |
          DEPLOYED_FILE=sing-box/last_deployed_tag
          last=""
          [ -f "$DEPLOYED_FILE" ] && last=$(<"$DEPLOYED_FILE")
          if [ "$last" != "${{ steps.get.outputs.tag }}" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build sing-box binaries
    needs: poll
    if: needs.poll.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: linux-amd64
            goos: linux
            goarch: amd64
            goamd64: v1
            cgo: 0
            artifact: sing-box-linux-amd64
            tags: with_quic,with_gvisor,with_wireguard,with_utls,with_clash_api

          - name: linux-amd64-v3
            goos: linux
            goarch: amd64
            goamd64: v3
            cgo: 0
            artifact: sing-box-linux-amd64-v3
            tags: with_quic,with_gvisor,with_wireguard,with_utls,with_clash_api

          - name: linux-arm64
            goos: linux
            goarch: arm64
            cgo: 1
            artifact: sing-box-linux-arm64
            tags: with_quic,with_gvisor,with_wireguard,with_utls,with_clash_api,with_naive_outbound,with_musl

    steps:
      - name: Checkout sing-box @ ${{ needs.poll.outputs.tag }}
        uses: actions/checkout@v4
        with:
          repository: SagerNet/sing-box
          ref: ${{ needs.poll.outputs.tag }}
          fetch-depth: 0

      - name: Get Go version
        id: version
        run: |
          echo go_version=$(curl -s https://raw.githubusercontent.com/actions/go-versions/main/versions-manifest.json \
            | grep -oE '"version": "[0-9]+\.[0-9]+(\.[0-9]+)?"' \
            | head -1 | cut -d':' -f2 | tr -d ' "') >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ steps.version.outputs.go_version }}

      # ======== ① Clone cronet-go（仅 arm64 + cgo）========
      - name: Clone cronet-go
        if: matrix.goarch == 'arm64' && matrix.cgo == 1
        run: |
          git clone https://github.com/SagerNet/cronet-go.git ~/cronet-go
          cd ~/cronet-go
          git submodule update --init --recursive

      # ======== ② 下载 Chromium musl 工具链 ========
      - name: Download Chromium musl toolchain (arm64)
        if: matrix.goarch == 'arm64' && matrix.cgo == 1
        run: |
          cd ~/cronet-go
          go run ./cmd/build-naive \
            --target=linux/arm64 \
            --libc=musl \
            download-toolchain

      # ======== ③ 注入交叉编译环境变量 ========
      - name: Export Chromium toolchain env
        if: matrix.goarch == 'arm64' && matrix.cgo == 1
        run: |
          cd ~/cronet-go
          go run ./cmd/build-naive \
            --target=linux/arm64 \
            --libc=musl \
            env >> $GITHUB_ENV

      - name: Build ${{ matrix.name }}
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOAMD64: ${{ matrix.goamd64 }}
          CGO_ENABLED: ${{ matrix.cgo }}
          TAGS: ${{ matrix.tags }}
        run: make

      - name: Compress ${{ matrix.name }}
        run: upx sing-box

      - name: Upload ${{ matrix.name }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: sing-box
